# This is a spider that collects data from cve details
import scrapy,os,sys,re,csv
from web_scraping.items import CVE_NO

dir = os.path.abspath(os.getcwd())
results = []

for filename in os.listdir(dir):
    if filename == 'agent.log':
       f  = open(os.path.join(dir, 'agent.log'), "r")
       for vuln in f:
           if 'CVE' not in vuln:
               s=vuln
             
               with open(dir+"/"+"files_exploits.csv") as f_obj:
                   reader = csv.reader(f_obj, delimiter=',')
                   for line in reader:
                    
                       if line[2] in s:
                            
                            results.append(line[0])
                            
class QuotesSpider(scrapy.Spider):
    name = "get_cves"
    start_urls=[ 'https://www.exploit-db.com/exploits/']
    for i in results:    
        if str(results) != str(' '): 
            start_urls.append('https://www.exploit-db.com/exploits/'+str(i))
                  
    def parse(self, response):
        item = CVE_NO()
        cve = response.css('body > div.wrapper > div.main-panel > div.content > div > div > div:nth-child(1) > div > div.ml-2.mr-2 > div:nth-child(1) > div:nth-child(1) > div > div.card-body > div > div > div > div:nth-child(2) > h6 > a:nth-child(1)::text').get()
        cve = re.sub('[\W_]+', '-', str(cve)) #remove special characters
        cve=cve[1:]
        cve=cve[:-1] 																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																			
        if cve != None:
            item['cve_no'] = cve
            yield item
